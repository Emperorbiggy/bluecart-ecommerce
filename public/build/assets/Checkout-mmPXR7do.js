import{r as o,j as e}from"./app-DI3dqHrO.js";import{u as _}from"./CartContext-DSFRV-01.js";import{A as I}from"./AppLayout-DALwwK1e.js";import{v as M,f as O,d as A}from"./api-DUNuWHcy.js";import{B as L}from"./BlueCartLoader-BslhaR6Q.js";import"./createLucideIcon-DchA5xRf.js";import"./user-DV8XVIFs.js";function F(){const[n,y]=o.useState("paystack"),[s,j]=o.useState(null),[b,w]=o.useState(!0),[N,h]=o.useState(!1),{cart:d,clearCart:f}=_(),[v,p]=o.useState(!1),[S,i]=o.useState(!1),[k,g]=o.useState(null),u=d.reduce((l,t)=>l+t.price*t.quantity,0),m=Math.round(u*.075),x=u+m;o.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("reference");t&&(async()=>{try{const a=await M(t),r=JSON.parse(localStorage.getItem("checkout_order"));a.status==="success"?(g((r==null?void 0:r.orderId)||a.order_id||"N/A"),p(!0),f(),localStorage.removeItem("checkout_order")):i(!0)}catch(a){console.error("Payment verification failed:",a),i(!0)}})()},[]),o.useEffect(()=>{(async()=>{try{const t=await O();j(t.user)}catch{console.warn("No user logged in")}finally{w(!1)}})()},[]);const P=async()=>{if(!s)return alert("Please log in or register first.");if(d.length===0)return alert("Your cart is empty.");h(!0);const l=d.map(t=>({product_id:t.id,quantity:t.quantity,price:t.price}));try{const t=await A({items:l,paymentMethod:n,vat:m,totalPrice:x}),a=t==null?void 0:t.order,r=t==null?void 0:t.payment;if(localStorage.setItem("checkout_order",JSON.stringify({orderId:(a==null?void 0:a.order_id)||null,reference:(r==null?void 0:r.reference)||null,userEmail:s.email,userPhone:s.phone,amount:(r==null?void 0:r.amount)||x,timestamp:Date.now()})),n==="paystack"){const c=t==null?void 0:t.payment_url;c?window.location.href=c:alert("Failed to redirect to Paystack.")}else g((a==null?void 0:a.order_id)||"N/A"),p(!0),f()}catch(t){console.error(t),alert("An error occurred while placing the order.")}finally{h(!1)}};return b||N?e.jsx(L,{}):e.jsxs("section",{className:"max-w-7xl mx-auto px-4 py-16",children:[e.jsx("h1",{className:"text-3xl font-bold text-[#130447] mb-10",children:"Checkout"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-12",children:[e.jsx("div",{className:"lg:col-span-2 bg-white p-6 shadow rounded-md",children:s?e.jsxs(e.Fragment,{children:[e.jsx("h2",{className:"text-xl font-semibold text-[#130447] mb-4",children:"Billing Details"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("input",{disabled:!0,className:"w-full border px-4 py-2 rounded-md",value:s.name||""}),e.jsx("input",{disabled:!0,className:"w-full border px-4 py-2 rounded-md",value:s.email||""}),(()=>{var r,c;const l=((r=s.billing_address)==null?void 0:r.split(","))||[],t=l.filter((D,C)=>C!==2).join(",").trim(),a=((c=l[2])==null?void 0:c.trim())||"";return e.jsxs(e.Fragment,{children:[e.jsx("input",{disabled:!0,className:"w-full border px-4 py-2 rounded-md md:col-span-2",value:t}),e.jsx("input",{disabled:!0,className:"w-full border px-4 py-2 rounded-md",value:a})]})})(),e.jsx("input",{disabled:!0,className:"w-full border px-4 py-2 rounded-md",value:s.phone||""})]})]}):e.jsx("div",{className:"text-gray-600",children:"Please log in to continue checkout."})}),e.jsxs("div",{className:"bg-white p-6 shadow rounded-md",children:[e.jsx("h2",{className:"text-xl font-bold text-[#130447] mb-4",children:"Order Summary"}),e.jsxs("div",{className:"space-y-3 text-gray-700",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"Subtotal"}),e.jsxs("span",{children:["₦",u.toLocaleString()]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{children:"VAT (7.5%)"}),e.jsxs("span",{children:["₦",m.toLocaleString()]})]}),e.jsx("hr",{}),e.jsxs("div",{className:"flex justify-between font-bold text-[#130447] text-lg",children:[e.jsx("span",{children:"Total"}),e.jsxs("span",{children:["₦",x.toLocaleString()]})]})]}),e.jsxs("div",{className:"mt-6",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Payment Method"}),e.jsxs("select",{value:n,onChange:l=>y(l.target.value),className:"w-full border px-4 py-2 rounded-md",children:[e.jsx("option",{value:"paystack",children:"Pay with Paystack"}),e.jsx("option",{value:"cod",children:"Cash on Delivery"})]})]}),e.jsx("button",{onClick:P,className:"mt-6 w-full bg-[#130447] text-white py-3 rounded-md hover:bg-[#0f0334] transition shadow-md text-lg font-semibold",children:"Confirm & Pay"})]})]}),v&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-md w-full p-6 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-green-600 mb-2",children:"Order Placed Successfully!"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"Thank you for your order."}),e.jsxs("p",{className:"text-sm mb-2",children:[e.jsx("strong",{children:"Order ID:"})," ",k]}),e.jsxs("p",{className:"text-sm mb-4",children:["We will contact you at ",e.jsx("strong",{children:s==null?void 0:s.email})," or ",e.jsx("strong",{children:s==null?void 0:s.phone}),"."]}),e.jsx("button",{onClick:()=>window.location.href="/dashboard",className:"bg-[#130447] text-white px-4 py-2 rounded-md mt-4 hover:bg-[#0f0334]",children:"Go to Dashboard"})]})}),S&&e.jsx("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-60",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg max-w-md w-full p-6 text-center",children:[e.jsx("h2",{className:"text-2xl font-bold text-red-600 mb-2",children:"Payment Failed!"}),e.jsx("p",{className:"text-gray-700 mb-4",children:"We couldn’t verify your payment. Please try again."}),e.jsx("button",{onClick:()=>i(!1),className:"bg-red-600 text-white px-4 py-2 rounded-md mt-4 hover:bg-red-700",children:"Close"})]})})]})}F.layout=n=>e.jsx(I,{children:n});export{F as default};
